# ëŒ“ê¸€ ì‘ì„± ( INSERT + 2ì¤‘ FK )

## ğŸ¯ í•™ìŠµ ëª©í‘œ

- ëŒ“ê¸€ì€ ê²Œì‹œê¸€(post_id) ê³¼ ì‘ì„±ì(user_id) ë¥¼ ë™ì‹œì— ì°¸ì¡°í•œë‹¤

- ì¦‰, ëŒ“ê¸€ í…Œì´ë¸”ì€ 2ì¤‘ FK(ì™¸ë˜í‚¤ 2ê°œ) ë¥¼ ê°€ì§„ë‹¤ëŠ” ê²ƒì„ ì´í•´í•œë‹¤

- ë¡œê·¸ì¸í•œ ì‚¬ìš©ìë§Œ ëŒ“ê¸€ì„ ì‘ì„±í•  ìˆ˜ ìˆë„ë¡ ì œì–´í•œë‹¤

- INSERT ë¬¸ìœ¼ë¡œ comments í…Œì´ë¸”ì— ëŒ“ê¸€ì„ ì €ì¥í•œë‹¤

- PDOì˜ prepare â†’ bindValue â†’ execute íŒ¨í„´ì„ ë°˜ë³µ í•™ìŠµí•œë‹¤

---

# 1. ëŒ“ê¸€ ì‘ì„± ê¸°ëŠ¥ ê°œìš”

ëŒ“ê¸€ ì‘ì„±ì€ ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ì—ì„œ ì´ë£¨ì–´ì§„ë‹¤.

```sql
ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ (?id=ê²Œì‹œê¸€ID)
â†’ ëŒ“ê¸€ ì…ë ¥ í¼ ì¶œë ¥
â†’ POST ìš”ì²­ ì „ì†¡
â†’ PHPì—ì„œ ì„¸ì…˜ + ì…ë ¥ê°’ + post_id ì²˜ë¦¬
â†’ INSERT SQL ì‹¤í–‰
â†’ comments í…Œì´ë¸”ì— ë°ì´í„° ì €ì¥
â†’ ë‹¤ì‹œ ê²Œì‹œê¸€ ìƒì„¸ë¡œ ì´ë™
```

## 1-1. comments í…Œì´ë¸” êµ¬ì¡° ë³µìŠµ (2ì¤‘ FK)
| ì»¬ëŸ¼ëª…        | ì„¤ëª…                          |
| ---------- | --------------------------- |
| id         | ëŒ“ê¸€ PK (AUTO_INCREMENT)      |
| post_id    | ëŒ€ìƒ ê²Œì‹œê¸€ ID (posts.id ì°¸ì¡°, FK) |
| user_id    | ëŒ“ê¸€ ì‘ì„±ì ID (users.id ì°¸ì¡°, FK) |
| comment    | ëŒ“ê¸€ ë‚´ìš©                       |
| created_at | ì‘ì„±ì¼                         |
> comments.post_id ëŠ” posts.id ë¥¼ ì°¸ì¡°í•˜ëŠ” FK   
> comments.user_id ëŠ” users.id ë¥¼ ì°¸ì¡°í•˜ëŠ” FK   
> â†’ ëŒ“ê¸€ì€ FKê°€ 2ê°œë‹¤.

--- 

# 2. ëŒ“ê¸€ ì‘ì„± í¼ ì¶”ê°€ (ê²Œì‹œê¸€ ìƒì„¸ í˜ì´ì§€ì— í¬í•¨)

## 2-1. post_view.phpì— ëŒ“ê¸€ ì‘ì„± í¼ ë¶™ì´ê¸°
> ê²Œì‹œê¸€ ìƒì„¸ í™”ë©´ í•˜ë‹¨ì— ì•„ë˜ í¼ì„ ì¶”ê°€í•œë‹¤.   
> post_idëŠ” URLì˜ id ê°’ì„ hidden inputìœ¼ë¡œ ì „ë‹¬í•œë‹¤.

```php
<hr>

<h2>ëŒ“ê¸€ ì‘ì„±</h2>

<?php if (isset($_SESSION["user"])): ?>
  <form method="post" action="/comment_create_action.php">
    <input type="hidden" name="post_id" value="<?= htmlspecialchars($post["id"]) ?>">

    <p>
      <textarea name="comment" rows="4" cols="60" required></textarea>
    </p>

    <p>
      <button type="submit">ëŒ“ê¸€ ë“±ë¡</button>
    </p>
  </form>
<?php else: ?>
  <p>
    ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.
    <a href="/login.php">ë¡œê·¸ì¸</a>
  </p>
<?php endif; ?>
```

### 2-2. session ì‚¬ìš©
íŒŒì¼ ì œì¼ ìœ„ì—
```php
session_start();
```

---

# 3. ëŒ“ê¸€ ì €ì¥ ì²˜ë¦¬ ( INSERT + 2ì¤‘ FK )

## 3-1. INSERT SQL
```sql
INSERT INTO comments (post_id, user_id, comment)
VALUES (:post_id, :user_id, :comment);
```

## 3-2. public/comment_create_action.php
```php
<?php
require_once dirname(__DIR__) . "/lib/db.php";

session_start();

// ë¡œê·¸ì¸ ì²´í¬ (ëŒ“ê¸€ ì‘ì„±ì€ ë¡œê·¸ì¸ í•„ìˆ˜)
if (!isset($_SESSION["user"])) {
  echo "ë¡œê·¸ì¸ í›„ ì´ìš© ê°€ëŠ¥í•©ë‹ˆë‹¤.";
  exit;
}

$pdo = db();

// --------------------------------------------------
// ì„¸ì…˜ì—ì„œ ë¡œê·¸ì¸ ì‚¬ìš©ì ID ê°€ì ¸ì˜¤ê¸°
// --------------------------------------------------
$userId = (int) $_SESSION["user"]["id"];

// --------------------------------------------------
// POST ë°ì´í„° ìˆ˜ì‹ 
// --------------------------------------------------
$postId  = $_POST["post_id"] ?? null;
$comment = $_POST["comment"] ?? "";

// --------------------------------------------------
// ì…ë ¥ê°’ ê²€ì¦
// --------------------------------------------------
if ($postId === null || !ctype_digit((string)$postId)) {
  echo "ì˜ëª»ëœ ì ‘ê·¼ì…ë‹ˆë‹¤.";
  exit;
}

if ($comment === "") {
  echo "ëŒ“ê¸€ ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”.";
  exit;
}

// --------------------------------------------------
// SQL ì¤€ë¹„ (INSERT + 2ì¤‘ FK)
// --------------------------------------------------
$sql = "
  INSERT INTO comments (post_id, user_id, comment)
  VALUES (:post_id, :user_id, :comment)
";

$stmt = $pdo->prepare($sql);

// --------------------------------------------------
// ë°”ì¸ë”©
// --------------------------------------------------
$stmt->bindValue(":post_id", (int)$postId, PDO::PARAM_INT);
$stmt->bindValue(":user_id", $userId, PDO::PARAM_INT);
$stmt->bindValue(":comment", $comment, PDO::PARAM_STR);

// --------------------------------------------------
// ì‹¤í–‰
// --------------------------------------------------
$stmt->execute();

// --------------------------------------------------
// ëŒ“ê¸€ ì‘ì„± í›„ ì›ë˜ ê²Œì‹œê¸€ ìƒì„¸ë¡œ ì´ë™
// --------------------------------------------------
header("Location: /post_view.php?id=" . (int)$postId);
exit;
```

---

# 4. 2ì¤‘ FKê°€ ëŒ“ê¸€ ì‘ì„±ì— ë¯¸ì¹˜ëŠ” ì˜í–¥

commentsëŠ” FKê°€ 2ê°œì´ë¯€ë¡œ ë‹¤ìŒì´ ë³´ì¥ëœë‹¤.

- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ê²Œì‹œê¸€ì—ëŠ” ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ì—†ë‹¤ (post_id FK)

- ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì‚¬ìš©ìëŠ” ëŒ“ê¸€ì„ ë‹¬ ìˆ˜ ì—†ë‹¤ (user_id FK)

- ëŒ“ê¸€ ë°ì´í„°ì˜ ë¬´ê²°ì„±ì´ ìœ ì§€ëœë‹¤

> ì¦‰, ëŒ“ê¸€ì€ â€œì–´ë–¤ ê¸€ì—, ëˆ„ê°€ ë‹¬ì•˜ëŠ”ì§€â€ê°€ DBì—ì„œ ê°•ì œëœë‹¤.