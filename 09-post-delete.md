# 게시글 삭제 ( DELETE + WHERE )

## 🎯 학습 목표

- DELETE + WHERE 로 게시글 1건을 삭제한다

- 로그인한 사용자만 삭제 가능하게 만든다

- 내가 쓴 글만 삭제 가능하게 권한을 체크한다

- GET 파라미터(id) 검증을 다시 반복한다

- PDO prepare → bindValue → execute 패턴을 반복한다

- 댓글 FK 때문에 삭제가 막히는 상황을 체험한다

---

# 1. 삭제 기능 개요

게시글 삭제는 “특정 게시글 1개”를 없애는 기능이다.
```sql
게시글 상세 페이지 (?id=게시글ID)
→ 삭제 버튼 클릭 (POST)
→ PHP에서 로그인 + 권한 체크
→ DELETE SQL 실행
→ 목록으로 이동
```
- 삭제는 항상 WHERE로 대상을 특정해야 한다.
- WHERE 없이 삭제하면 테이블 전체가 삭제된다.

---

# 2. 삭제 버튼 추가 (상세 페이지에 붙이기)

게시글 상세 페이지(post_view.php)에서 작성자 본인만 삭제 버튼이 보이게 한다.

## 2-1. post_view.php

삭제권한 체크 PHP 코드 추가
```php
$isOwner = false;
$loginUserId = null;

if (isset($_SESSION["user"])) {
  $loginUserId = (int) $_SESSION["user"]["id"];
  $postUserId  = (int) $post["user_id"];
  $isOwner = ($loginUserId === $postUserId);
}
```

삭제버튼 HTML 추가
```php
<p>
  <?php if ($isOwner): ?>
    <form method="post" action="/post_delete_action.php" onsubmit="return confirm('정말 삭제할까요?');">
      <input type="hidden" name="id" value="<?= htmlspecialchars((string)$post["id"]) ?>">
      <button type="submit">삭제</button>
    </form>
  <?php endif; ?>
  <a href="/">목록으로</a>
</p>
```

---

# 3. 삭제 처리 로직 (DELETE + WHERE + 권한 체크)

## 3-1. DELETE SQL
```sql
DELETE FROM posts
WHERE id = :id;
```
- 핵심: WHERE 없으면 전체 삭제
- 삭제는 항상 “딱 1건”을 겨냥해야 한다.

## 3-2. public/post_delete_action.php 작성
```php
<?php
// --------------------------------------------------
// DB 연결 함수 포함
// lib/db.php 안에는 db() 함수(PDO 반환)가 정의되어 있음
// --------------------------------------------------
require_once dirname(__DIR__) . "/lib/db.php";

// --------------------------------------------------
// 세션 시작
// 로그인 여부 및 로그인 사용자 정보 사용을 위해 필요
// --------------------------------------------------
session_start();

// --------------------------------------------------
// 로그인 체크
// 삭제는 로그인한 사용자만 가능
// --------------------------------------------------
if (!isset($_SESSION["user"])) {
  echo "로그인 후 이용 가능합니다.";
  exit;
}

// --------------------------------------------------
// DB 연결 (PDO 객체 생성)
// --------------------------------------------------
$pdo = db();

// --------------------------------------------------
// POST 데이터 수신
// 삭제 대상 게시글 ID
// --------------------------------------------------
$id = $_POST["id"] ?? null;

// --------------------------------------------------
// 입력값 검증
// - id가 없거나
// - 숫자가 아니면 잘못된 접근
// --------------------------------------------------
if ($id === null || !ctype_digit((string) $id)) {
  echo "잘못된 접근입니다.";
  exit;
}

// --------------------------------------------------
// 타입 캐스팅
// --------------------------------------------------
$postId = (int) $id;                          // 삭제할 게시글 ID
$loginUserId = (int) $_SESSION["user"]["id"]; // 로그인한 사용자 ID

// --------------------------------------------------
// DELETE SQL
// - 게시글 ID(id)
// - 작성자 ID(user_id)
// 둘 다 만족하는 경우에만 삭제됨
// → DB 차원에서 권한 체크까지 함께 수행
// --------------------------------------------------
$sql = "
  DELETE FROM posts
  WHERE id = :id
  AND user_id = :user_id
";

// --------------------------------------------------
// SQL 준비 (아직 실행되지 않음)
// --------------------------------------------------
$stmt = $pdo->prepare($sql);

// --------------------------------------------------
// 값 바인딩
// - id, user_id 는 정수이므로 PDO::PARAM_INT 사용
// --------------------------------------------------
$stmt->bindValue(":id", $postId, PDO::PARAM_INT);
$stmt->bindValue(":user_id", $loginUserId, PDO::PARAM_INT);

// --------------------------------------------------
// SQL 실행
// 이 시점에 실제 DELETE가 수행됨
// --------------------------------------------------
$stmt->execute();

// --------------------------------------------------
// 삭제된 행 수 확인
// rowCount() === 0 인 경우
// - 게시글이 존재하지 않거나
// - 본인 글이 아닌 경우
// --------------------------------------------------
if ($stmt->rowCount() === 0) {
  echo "삭제할 수 없습니다. (존재하지 않거나 권한 없음)";
  exit;
}

// --------------------------------------------------
// 삭제 완료 후 메인페이지(목록)로 이동
// --------------------------------------------------
header("Location: /");
exit;
```

---

# 🧩 실습 / 과제


## 1. Comments 테이블에 fk_comments_posts1 ( FK ) 수정

On Delete - CASCADE 를

On Delete - RESTRICT 로 변경해서 댓글 있는글 삭제해보기
